# Форма выставления счета {#webform_ru}

###### Последнее обновление: 2017-07-11 | [Редактировать на GitHub](https://github.com/QIWI-API/pull-payments-docs/blob/master/_webform_ru.html.md)


Клиенту отображается платежная форма с выбором способа оплаты выставленного счета.

* Вызов веб-формы может выполняться двумя способами:

  * WF - вызов формы без авторизации. Номер телефона, на который будет выставлен счет, должен быть указан в параметрах вызова.

  * WF/auth - в параметрах вызова формы содержатся идентификатор для авторизации и цифровая подпись. Номер телефона может указать клиент непосредственно на веб-форме. Данный способ находится в статусе бета-версии. Для его использования необходимо обратиться в Техническую поддержку КИВИ (bss@qiwi.ru).

### Последовательность операций:

1. Пользователь формирует заказ на сайте провайдера.
2. Далее провайдер выполняет вызов веб-формы. В запросе может использоваться авторизация провайдера. В способе WF w/auth при отсутствии номера телефона в параметрах вызова пользователь указывает свой номер телефона на форме.
3. В случае успешного создания счета пользователь автоматически переходит на [платежную форму](#checkout_ru) Visa QIWI Wallet.
4. Если провайдер включил отправку [уведомлений на сервер провайдера](#notification_ru), то после проведения платежа система Visa QIWI Wallet высылает уведомление на сервер провайдера об оплате данного счета, либо, если пользователь отклонил счет, о неоплате. Уведомления об оплате счета содержат параметры авторизации, которые необходимо проверять на сервере провайдера.
5. После подтверждения оплаты счета провайдер исполняет заказ пользователя.

<h3 class="request method">Запрос → REDIRECT</h3>

<ul class="nestedList url">
    <li><h3>URL <span>https://bill.qiwi.com/order/external/create.action</span></h3></li>
</ul>

~~~http
  Без авторизации
GET /order/external/create.action?comm=test&txn_id=0000&from=000000&summ=1.11&successUrl=http%3A%2F%2Ftest.ru%3Fcurrency=643&to=%2B71234567890 HTTP/1.1
Host: bill.qiwi.com
~~~

<ul class="nestedList example">
    <li><h3>Пример без авторизации</h3><span><a>https://bill.qiwi.com/order/external/create.action?comm=test&txn_id=0000&from=000000&summ=1.11&successUrl=http%3A%2F%2Ftest.ru%3Fcurrency=643&to=%2B71234567890</a></span>
    </li>
</ul>

~~~http
  C авторизацией
GET /order/external/create.action?from=260831&txn_id=q115928&summ=1.12&api_id=46835183&currency=RUB&sign=7d3e8b8df7c8ed70b1089c6a5ae86eddd1ee HTTP/1.1
Host: bill.qiwi.com
~~~

<ul class="nestedList example">
    <li><h3>Пример c авторизацией</h3><span><a>https://bill.qiwi.com/order/external/create.action?from=260831&txn_id=q115928&summ=1.12&api_id=46835183&currency=RUB&sign=7d3e8b8df7c8ed70b1089c6a5ae86eddd1ee</a></span>
    </li>
</ul>

<ul class="nestedList params">
    <li><h3>Параметры</h3><span>В ссылке на веб-форму указываются параметры счета.</span></li>
</ul>





Параметр|Описание|Тип|WF/auth|WF|Обяз.
---------|--------|---|---------|---|----
from | Идентификатор провайдера. Идентификатор указан в настройках HTTP-протокола в личном кабинете провайдера на сайте ishop.qiwi.com|Integer|+|+|+
to | Идентификатор номера QIWI Wallet, на который выставляется счет (в международном формате). Не обязателен для WF/auth: если не указан, то пользователю отображается веб-форма с полем ввода номера телефона и счет выставляется только после заполнения номера | String(20)|+|+|WF
summ | Сумма, на которую выставляется счет. Способ округления зависит от валюты | Number(6.3)|+|+|+
currency | Идентификатор валюты (Alpha-3 ISO 4217 код). Может использоваться любая валюта, предусмотренная договором с КИВИ | String(3)|+|+|+
txn_id|Уникальный идентификатор счета в системе провайдера|String(30)|+|+|WF/auth
api_id|[Параметры авторизации](#auth_param)|Integer|+|-|WF/auth
sign|[Подпись запроса](#http_sign)|String|+|-|WF/auth
comm | Комментарий к счету. Если не указан для WF/auth, и не указан параметр `to`, то пользователю отображается веб-форма с полями ввода номера телефона и комментария. Счет выставляется только после заполнения номера| String(255)|+|+|-
lifetime | Дата, до которой счет будет доступен для оплаты. Если счет не будет оплачен до этой даты, ему присваивается финальный статус и последующая оплата станет невозможна.<br> **Внимание! По истечении 28 суток от даты выставления счет автоматически будет переведен в финальный статус.**|ГГГГ-ММ-ДДTЧЧММ|+|+|-
iframe| Признак отображения страницы в iframe (более компактный вид, удобный для встраивания ее в сайт провайдера).|Логический, `true`/`false`<br>По умолчанию `false`|+|+|-
successUrl|URL для переадресации в случае успешного создания транзакции в Visa QIWI Wallet. Ссылка должна вести на сайт провайдера. Если пользователь выбрал на платежной форме способ оплаты, отличный от оплаты с баланса Visa QIWI Wallet, то переадресация на сайт провайдера не выполняется.|URL-закодированная строка|+|+|-
failUrl|URL для переадресации в случае неуспеха при создании транзакции в Visa QIWI Wallet. Ссылка должна вести на сайт провайдера. Если пользователь выбрал на платежной форме способ оплаты, отличный от оплаты с баланса Visa QIWI Wallet, то переадресация на сайт провайдера не выполняется.|URL-закодированная строка|+|+|-
target|Флаг, показывающий, что ссылки в параметрах <br>`successUrl` / `failUrl` открываются в iframe. Если отсутствует, то считается выключенным|Строка (только `iframe`)|+|+|-
pay_source |Способ оплаты по умолчанию, который необходимо отобразить пользователю при открытии платежной формы. Возможные значения:<br>`qw` – оплата с баланса Visa QIWI Wallet;<br> `mobile` – оплата с баланса мобильного телефона;<br> `card` – оплата банковской картой;<br> `wm` – оплата с привязанного кошелька WebMoney;<br> `ssk` – оплата наличными в терминале QIWI.<br>Если способ оплаты не доступен, пользователю отображается предупреждение, при этом на странице можно выбрать другие способы оплаты. |String|+|+|-

## Подпись {#http_sign}

Запрос выставления счета с авторизацией требует вычисления параметра `sign` (цифровой подписи).

<aside class="notice">
Для вычисления подписи используется API password – пароль, соответствующий <a href='#auth_param'>API_ID</a>
</aside>

Алгоритм вычисления подписи:

1.	Получить строку, содержащую значения всех обязательных параметров GET-запроса и параметра `lifetime` (если он присутствует в запросе) в алфавитном порядке перечисления параметров, разделенных символами `|`:

    `Invoice_parameters = "{api_id}|{currency}|{from}|{lifetime}|{summ}|{txn_id}"`

    где `{parameter}` – значение соответствующего параметра запроса.

2.	Вычислить HMAC-хэш с шифрованием SHA256 от полученной строки и ключом, равным API password (пароль к API ID):

    `sign = HMAС(SHA256, API_password, Invoice_parameters)`

Пример генерации подписи на вкладке **PHP** справа.

~~~php
<?php

?>
~~~